import streamlit as st
import pandas as pd
from datetime import datetime

st.set_page_config(page_title="Everest Management", layout="wide")

# ì´ˆê¸° ì„¸ì…˜ ìƒíƒœ ì„¤ì •
if "inventory" not in st.session_state:
    st.session_state.inventory = pd.DataFrame(columns=["ì§€ì ", "í’ˆëª©ëª…", "ì¹´í…Œê³ ë¦¬", "ë‹¨ìœ„", "í˜„ì¬ìˆ˜ëŸ‰", "ìµœì†Œìˆ˜ëŸ‰", "ë¹„ê³ "])
if "staff" not in st.session_state:
    st.session_state.staff = pd.DataFrame(columns=["ì§€ì ", "ì´ë¦„", "ì§ì±…", "ì—­í• ", "ê·¼ë¬´í˜•íƒœ", "ì—°ë½ì²˜", "ë¹„ê³ "])
if "customers" not in st.session_state:
    st.session_state.customers = pd.DataFrame(columns=["ì´ë¦„", "ì—°ë½ì²˜", "ë°©ë¬¸ì§€ì ", "ìµœê·¼ë°©ë¬¸ì¼", "ë©”ëª¨"])


st.title("EVEREST í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ (ë² íƒ€)")

menu = st.sidebar.radio(
    "ë©”ë‰´ ì„ íƒ",
    ("ğŸ“¦ ì¬ê³ ê´€ë¦¬", "ğŸ‘¥ ì¸ë ¥ê´€ë¦¬", "ğŸ’³ ê³ ê°ê´€ë¦¬", "ğŸ“Š ëŒ€ì‹œë³´ë“œ(ìš”ì•½)")
)

branches = ["ë™ëŒ€ë¬¸", "êµ¿ëª¨ë‹ì‹œí‹°", "ì–‘ì¬", "ìˆ˜ì›ì˜í†µ", "ë™íƒ„", "ì˜ë“±í¬", "ë£¸ë¹„ë‹ˆ"]


# ğŸ“¦ ì¬ê³ ê´€ë¦¬
if menu == "ğŸ“¦ ì¬ê³ ê´€ë¦¬":
    st.subheader("ì¬ê³  ì…ë ¥")

    col1, col2, col3 = st.columns(3)
    with col1:
        branch = st.selectbox("ì§€ì ", branches, key="inv_branch")
        name = st.text_input("í’ˆëª©ëª…", key="inv_name")
        category = st.selectbox("ì¹´í…Œê³ ë¦¬", ["ìœ¡ë¥˜", "ì•¼ì±„", "í–¥ì‹ ë£Œ", "ì†ŒìŠ¤", "ìŒë£Œ", "ê¸°íƒ€"], key="inv_cat")
    with col2:
        unit = st.text_input("ë‹¨ìœ„ (ì˜ˆ: kg, ê°œ, ë°•ìŠ¤)", key="inv_unit")
        qty = st.number_input("í˜„ì¬ ìˆ˜ëŸ‰", min_value=0.0, step=1.0, key="inv_qty")
        min_qty = st.number_input("ìµœì†Œ í•„ìš” ìˆ˜ëŸ‰", min_value=0.0, step=1.0, key="inv_min")
    with col3:
        note = st.text_input("ë¹„ê³ ", key="inv_note")
        add_btn = st.button("ì¬ê³  ë“±ë¡ / ì—…ë°ì´íŠ¸")

    if add_btn:
        if name.strip() == "":
            st.warning("í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.")
        else:
            df = st.session_state.inventory

            # ê°™ì€ ì§€ì +í’ˆëª© ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì¶”ê°€
            mask = (df["ì§€ì "] == branch) & (df["í’ˆëª©ëª…"] == name)
            new_row = {
                "ì§€ì ": branch,
                "í’ˆëª©ëª…": name,
                "ì¹´í…Œê³ ë¦¬": category,
                "ë‹¨ìœ„": unit,
                "í˜„ì¬ìˆ˜ëŸ‰": qty,
                "ìµœì†Œìˆ˜ëŸ‰": min_qty,
                "ë¹„ê³ ": note,
            }

            if mask.any():
                st.session_state.inventory.loc[mask, :] = list(new_row.values())
                st.success("ê¸°ì¡´ í’ˆëª© ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
            else:
                st.session_state.inventory = pd.concat(
                    [df, pd.DataFrame([new_row])],
                    ignore_index=True
                )
                st.success("ìƒˆ ì¬ê³  í’ˆëª©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")

    st.markdown("---")
    st.subheader("ì¬ê³  í˜„í™©")

    # í•„í„°
    f_col1, f_col2 = st.columns(2)
    with f_col1:
        f_branch = st.multiselect("ì§€ì  í•„í„°", branches, default=branches)
    with f_col2:
        show_only_low = st.checkbox("ìµœì†Œìˆ˜ëŸ‰ ì´í•˜ë§Œ ë³´ê¸° (ë°œì£¼ í•„ìš”)")

    inv_view = st.session_state.inventory.copy()
    inv_view = inv_view[inv_view["ì§€ì "].isin(f_branch)]

    if show_only_low:
        inv_view = inv_view[inv_view["í˜„ì¬ìˆ˜ëŸ‰"] <= inv_view["ìµœì†Œìˆ˜ëŸ‰"]]

    st.dataframe(inv_view, use_container_width=True)

# ğŸ‘¥ ì¸ë ¥ê´€ë¦¬
elif menu == "ğŸ‘¥ ì¸ë ¥ê´€ë¦¬":
    st.subheader("ì§ì› ì •ë³´ ë“±ë¡")

    c1, c2, c3 = st.columns(3)
    with c1:
        s_branch = st.selectbox("ì§€ì ", branches, key="st_branch")
        s_name = st.text_input("ì´ë¦„", key="st_name")
        s_role = st.selectbox("ì—­í• ", ["í™€", "ì£¼ë°©-ì»¤ë¦¬", "ì£¼ë°©-ë‚œ", "ì£¼ë°©-ë‘˜ë‹¤", "ë°”", "ë§¤ë‹ˆì €", "ê¸°íƒ€"], key="st_role")
    with c2:
        s_position = st.text_input("ì§ì±… (ì˜ˆ: ë§¤ë‹ˆì €, ìŠ¤íƒ­)", key="st_pos")
        s_type = st.selectbox("ê·¼ë¬´í˜•íƒœ", ["ì •ê·œ", "íŒŒíŠ¸", "ì•Œë°”"], key="st_type")
    with c3:
        s_phone = st.text_input("ì—°ë½ì²˜", key="st_phone")
        s_note = st.text_input("ë¹„ê³ ", key="st_note")
        s_add = st.button("ì§ì› ë“±ë¡ / ì—…ë°ì´íŠ¸")

    if s_add:
        if s_name.strip() == "":
            st.warning("ì§ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.")
        else:
            df = st.session_state.staff
            mask = (df["ì§€ì "] == s_branch) & (df["ì´ë¦„"] == s_name)

            new_row = {
                "ì§€ì ": s_branch,
                "ì´ë¦„": s_name,
                "ì§ì±…": s_position,
                "ì—­í• ": s_role,
                "ê·¼ë¬´í˜•íƒœ": s_type,
                "ì—°ë½ì²˜": s_phone,
                "ë¹„ê³ ": s_note,
            }

            if mask.any():
                st.session_state.staff.loc[mask, :] = list(new_row.values())
                st.success("ê¸°ì¡´ ì§ì› ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
            else:
                st.session_state.staff = pd.concat(
                    [df, pd.DataFrame([new_row])],
                    ignore_index=True
                )
                st.success("ìƒˆ ì§ì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")

    st.markdown("---")
    st.subheader("ì§ì› ëª©ë¡ / í•„í„°")

    sc1, sc2 = st.columns(2)
    with sc1:
        f_branch = st.multiselect("ì§€ì  í•„í„°", branches, default=branches, key="st_f_branch")
    with sc2:
        f_role = st.multiselect("ì—­í•  í•„í„°", ["í™€", "ì£¼ë°©-ì»¤ë¦¬", "ì£¼ë°©-ë‚œ", "ì£¼ë°©-ë‘˜ë‹¤", "ë°”", "ë§¤ë‹ˆì €", "ê¸°íƒ€"], key="st_f_role")

    staff_view = st.session_state.staff.copy()
    if f_branch:
        staff_view = staff_view[staff_view["ì§€ì "].isin(f_branch)]
    if f_role:
        staff_view = staff_view[staff_view["ì—­í• "].isin(f_role)]

    st.dataframe(staff_view, use_container_width=True)

# ğŸ’³ ê³ ê°ê´€ë¦¬
elif menu == "ğŸ’³ ê³ ê°ê´€ë¦¬":
    st.subheader("ê³ ê° ì •ë³´ ë“±ë¡")

    c1, c2, c3 = st.columns(3)
    with c1:
        c_name = st.text_input("ê³ ê° ì´ë¦„", key="c_name")
        c_phone = st.text_input("ì—°ë½ì²˜", key="c_phone")
    with c2:
        c_branch = st.selectbox("ì£¼ë¡œ ë°©ë¬¸ ì§€ì ", branches, key="c_branch")
        c_date = st.date_input("ìµœê·¼ ë°©ë¬¸ì¼", value=datetime.today(), key="c_date")
    with c3:
        c_memo = st.text_input("ë©”ëª¨ (ë‹¨ê³¨ íŠ¹ì§•, ì„ í˜¸ë©”ë‰´ ë“±)", key="c_memo")
        c_add = st.button("ê³ ê° ë“±ë¡ / ì—…ë°ì´íŠ¸")

    if c_add:
        if c_phone.strip() == "":
            st.warning("ì—°ë½ì²˜(ë˜ëŠ” ê³ ìœ ê°’)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
        else:
            df = st.session_state.customers
            mask = (df["ì—°ë½ì²˜"] == c_phone)

            new_row = {
                "ì´ë¦„": c_name,
                "ì—°ë½ì²˜": c_phone,
                "ë°©ë¬¸ì§€ì ": c_branch,
                "ìµœê·¼ë°©ë¬¸ì¼": c_date.strftime("%Y-%m-%d"),
                "ë©”ëª¨": c_memo,
            }

            if mask.any():
                st.session_state.customers.loc[mask, :] = list(new_row.values())
                st.success("ê¸°ì¡´ ê³ ê° ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
            else:
                st.session_state.customers = pd.concat(
                    [df, pd.DataFrame([new_row])],
                    ignore_index=True
                )
                st.success("ìƒˆ ê³ ê°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")

    st.markdown("---")
    st.subheader("ê³ ê° ëª©ë¡")

    cc1, cc2 = st.columns(2)
    with cc1:
        f_branch = st.multiselect("ì§€ì  í•„í„°", branches, default=branches, key="c_f_branch")
    with cc2:
        keyword = st.text_input("ì´ë¦„/ë©”ëª¨ ê²€ìƒ‰", key="c_keyword")

    cust_view = st.session_state.customers.copy()
    if f_branch:
        cust_view = cust_view[cust_view["ë°©ë¬¸ì§€ì "].isin(f_branch)]
    if keyword:
        kw = keyword.strip()
        cust_view = cust_view[
            cust_view["ì´ë¦„"].str.contains(kw, na=False)
            | cust_view["ë©”ëª¨"].str.contains(kw, na=False)
        ]

    st.dataframe(cust_view, use_container_width=True)

# ğŸ“Š ëŒ€ì‹œë³´ë“œ
elif menu == "ğŸ“Š ëŒ€ì‹œë³´ë“œ(ìš”ì•½)":
    st.subheader("ê°„ë‹¨ í˜„í™© ìš”ì•½")

    inv = st.session_state.inventory
    staff = st.session_state.staff
    cust = st.session_state.customers

    c1, c2, c3 = st.columns(3)
    with c1:
        st.metric("ë“±ë¡ëœ ì¬ê³  í’ˆëª© ìˆ˜", len(inv))
    with c2:
        st.metric("ë“±ë¡ëœ ì§ì› ìˆ˜", len(staff))
    with c3:
        st.metric("ë“±ë¡ëœ ê³ ê° ìˆ˜", len(cust))

    st.markdown("### ì§€ì ë³„ ì§ì› ìˆ˜")
    if len(staff) > 0:
        st.dataframe(staff.groupby("ì§€ì ")["ì´ë¦„"].count().rename("ì§ì›ìˆ˜").reset_index(), use_container_width=True)
    else:
        st.write("ì§ì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

    st.markdown("### ë°œì£¼ í•„ìš” í’ˆëª© (í˜„ì¬ìˆ˜ëŸ‰ â‰¤ ìµœì†Œìˆ˜ëŸ‰)")
    if len(inv) > 0:
        need = inv[inv["í˜„ì¬ìˆ˜ëŸ‰"] <= inv["ìµœì†Œìˆ˜ëŸ‰"]]
        if len(need) > 0:
            st.dataframe(need, use_container_width=True)
        else:
            st.write("ë°œì£¼ í•„ìš” í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.")
    else:
        st.write("ì¬ê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
